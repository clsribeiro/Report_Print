<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Contadores de Impressão</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@1.6.5/dist/flowbite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flowbite@1.6.5/dist/flowbite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #5D5CDE;
            --light-bg: #FFFFFF;
            --dark-bg: #181818;
            --light-text: #333333;
            --dark-text: #F0F0F0;
            --light-card: #F9FAFB;
            --dark-card: #242424;
            --light-border: #E5E7EB;
            --dark-border: #374151;
        }

        @media (prefers-color-scheme: dark) {
            .dark-mode {
                --bg-color: var(--dark-bg);
                --text-color: var(--dark-text);
                --card-bg: var(--dark-card);
                --border-color: var(--dark-border);
            }
        }

        @media (prefers-color-scheme: light) {
            .light-mode {
                --bg-color: var(--light-bg);
                --text-color: var(--light-text);
                --card-bg: var(--light-card);
                --border-color: var(--light-border);
            }
        }

        body {
            background-color: var(--bg-color, var(--light-bg));
            color: var(--text-color, var(--light-text));
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg, var(--light-card));
            border-color: var(--border-color, var(--light-border));
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
            border-top-color: var(--primary-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom tooltip styling */
        .custom-tooltip {
            position: relative;
            display: inline-block;
        }

        .custom-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--card-bg, var(--light-card));
            color: var(--text-color, var(--light-text));
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color, var(--light-border));
        }

        .custom-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .divider {
            height: 1px;
            background-color: var(--border-color, var(--light-border));
            margin: 1.5rem 0;
        }

        /* Tab styles */
        .tab-active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        /* Login form animation */
        .login-animation {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* User badge */
        .user-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: var(--primary-color);
            color: white;
        }

        .admin-badge {
            background-color: #5046e5;
        }

        .user-badge {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="dark:dark-mode light:light-mode">
    <!-- Auth Container -->
    <div id="authContainer" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="card max-w-md w-full p-8 rounded-lg shadow-lg border login-animation">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Login</h2>
                <button id="closeLoginModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Usuário</label>
                    <input type="text" id="username" class="bg-gray-50 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Seu nome de usuário" required>
                </div>
                <div>
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Senha</label>
                    <input type="password" id="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="••••••••" required>
                </div>
                <div id="loginError" class="text-red-600 text-sm hidden">
                    Usuário ou senha incorretos. Tente novamente.
                </div>
                <button type="submit" class="w-full px-5 py-3 text-base font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <div class="container mx-auto px-4 py-8">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold">Relatório de Contadores de Impressão</h1>
                    <p class="text-gray-600 dark:text-gray-300">Análise e acompanhamento de consumo de impressões</p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden">
                        <span id="userBadge" class="user-badge mr-2">
                            <span id="userIcon" class="mr-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </span>
                            <span id="userName">Usuário</span>
                        </span>
                        <button id="logoutButton" class="text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Sair
                            </div>
                        </button>
                    </div>
                    <button id="loginButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                            </svg>
                            Login
                        </div>
                    </button>
                </div>
            </header>

            <!-- File Import Section (Only visible to admins) -->
            <div id="fileImportSection" class="card p-6 rounded-lg shadow-md mb-8 border hidden">
                <h2 class="text-xl font-semibold mb-4">Importar Arquivo de Contador</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-grow">
                        <input type="file" id="csvFile" accept=".csv" class="hidden" />
                        <label for="csvFile" class="flex items-center justify-center p-4 border-2 border-dashed rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                            <div class="text-center">
                                <svg class="w-8 h-8 mx-auto mb-1 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Clique para selecionar um arquivo CSV</p>
                                <p id="selectedFileName" class="mt-1 text-xs text-gray-500 dark:text-gray-400">Nenhum arquivo selecionado</p>
                            </div>
                        </label>
                    </div>
                    <div class="flex items-end">
                        <button id="importButton" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Importar Dados
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center">
                    <div class="loading-spinner w-12 h-12 border-4 border-gray-300 border-t-4 rounded-full mb-4"></div>
                    <p class="text-gray-700 dark:text-gray-300">Processando dados...</p>
                </div>
            </div>

            <!-- Report Navigation -->
            <div id="reportNavigation" class="card p-6 rounded-lg shadow-md mb-8 border hidden">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <h2 class="text-xl font-semibold">Relatórios por Data de Importação</h2>
                    <div class="flex gap-2">
                        <select id="reportDate" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="current">Data Atual</option>
                            <option value="all">Contador Global</option>
                        </select>
                        <button id="shareReportButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="divider"></div>
                <div id="currentReportInfo" class="text-sm text-gray-600 dark:text-gray-400">
                    <p><span class="font-medium">Data de Importação:</span> <span id="importDate">-</span></p>
                    <p><span class="font-medium">Tipo de Relatório:</span> <span id="reportType">-</span></p>
                </div>
            </div>

            <!-- Dashboard Tabs -->
            <div id="dashboardContainer" class="hidden">
                <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-4 tab-active" id="summary-tab" data-tabs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Resumo</button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-4" id="details-tab" data-tabs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">Detalhes</button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-4" id="charts-tab" data-tabs-target="#charts" type="button" role="tab" aria-controls="charts" aria-selected="false">Gráficos</button>
                        </li>
                    </ul>
                </div>

                <div id="tabContent">
                    <!-- Summary Tab Content -->
                    <div class="block" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <div class="card p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">Total de Impressões</h3>
                                <p class="text-3xl font-bold text-indigo-600" id="totalPrintCount">0</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Total geral de páginas impressas</p>
                            </div>
                            <div class="card p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">Preto e Branco</h3>
                                <p class="text-3xl font-bold text-gray-800 dark:text-gray-200" id="bwPrintCount">0</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2"><span id="bwPercentage">0%</span> do total</p>
                            </div>
                            <div class="card p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">Coloridas</h3>
                                <p class="text-3xl font-bold text-indigo-500" id="colorPrintCount">0</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2"><span id="colorPercentage">0%</span> do total</p>
                            </div>
                            <div class="card p-6 rounded-lg shadow border">
                                <h3 class="text-lg font-semibold mb-2">Usuários Ativos</h3>
                                <p class="text-3xl font-bold text-green-600" id="activeUserCount">0</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Usuários com impressões</p>
                            </div>
                        </div>

                        <!-- Top Users -->
                        <div class="card p-6 rounded-lg shadow-md border mb-6">
                            <h3 class="text-xl font-semibold mb-4">Top 5 Usuários</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Nome</th>
                                            <th scope="col" class="px-6 py-3">Total</th>
                                            <th scope="col" class="px-6 py-3">P&B</th>
                                            <th scope="col" class="px-6 py-3">Colorido</th>
                                            <th scope="col" class="px-6 py-3">% do Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topUsersTableBody">
                                        <!-- Populated via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Usage Distribution Chart -->
                        <div class="card p-6 rounded-lg shadow-md border">
                            <h3 class="text-xl font-semibold mb-4">Distribuição de Uso</h3>
                            <div class="chart-container">
                                <canvas id="usageDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Details Tab Content -->
                    <div class="hidden" id="details" role="tabpanel" aria-labelledby="details-tab">
                        <div class="card p-6 rounded-lg shadow-md border mb-6">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Detalhes por Usuário</h3>
                                <div class="flex items-center mt-2 sm:mt-0">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                                            </svg>
                                        </div>
                                        <input type="text" id="userSearchInput" class="block p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg w-full bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Buscar por nome...">
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="name">
                                                Nome <span class="sort-icon"></span>
                                            </th>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="total">
                                                Total <span class="sort-icon"></span>
                                            </th>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="bw">
                                                P&B <span class="sort-icon"></span>
                                            </th>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="color">
                                                Colorido <span class="sort-icon"></span>
                                            </th>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="percentage">
                                                % do Total <span class="sort-icon"></span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="userDetailsTableBody">
                                        <!-- Populated via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <nav aria-label="Table navigation">
                                    <ul id="pagination" class="inline-flex items-center -space-x-px">
                                        <!-- Pagination will be generated via JavaScript -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Tab Content -->
                    <div class="hidden" id="charts" role="tabpanel" aria-labelledby="charts-tab">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- BW vs Color Chart -->
                            <div class="card p-6 rounded-lg shadow-md border">
                                <h3 class="text-xl font-semibold mb-4">P&B vs Colorido</h3>
                                <div class="chart-container">
                                    <canvas id="bwVsColorChart"></canvas>
                                </div>
                            </div>

                            <!-- Top 10 Users Chart -->
                            <div class="card p-6 rounded-lg shadow-md border">
                                <h3 class="text-xl font-semibold mb-4">Top 10 Usuários</h3>
                                <div class="chart-container">
                                    <canvas id="topUsersChart"></canvas>
                                </div>
                            </div>

                            <!-- Historical Trend Chart (if available) -->
                            <div class="card p-6 rounded-lg shadow-md border">
                                <h3 class="text-xl font-semibold mb-4">Tendência Histórica</h3>
                                <div id="historicalChartContainer" class="chart-container">
                                    <canvas id="historicalTrendChart"></canvas>
                                </div>
                                <div id="noHistoricalData" class="hidden flex items-center justify-center h-48 text-gray-500 dark:text-gray-400">
                                    <p>Dados históricos insuficientes. Importe mais arquivos para visualizar tendências.</p>
                                </div>
                            </div>

                            <!-- Usage by Hour Chart (for future use) -->
                            <div class="card p-6 rounded-lg shadow-md border">
                                <h3 class="text-xl font-semibold mb-4">Distribuição por Tipo</h3>
                                <div class="chart-container">
                                    <canvas id="usageTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="flex flex-col items-center justify-center py-12">
                <svg class="w-24 h-24 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h2 class="text-xl font-semibold mb-2 text-center">Nenhum dado importado</h2>
                <p class="text-gray-500 dark:text-gray-400 text-center max-w-md">
                    <span id="emptyStateMessage">Não há dados disponíveis para visualização. Aguarde até que um administrador importe um arquivo.</span>
                </p>
            </div>

            <!-- Share Report Modal -->
            <div id="shareReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Compartilhar Relatório</h3>
                        <button id="closeShareModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="mb-4 text-gray-600 dark:text-gray-300">Copie o link abaixo para compartilhar este relatório:</p>
                    <div class="flex mb-4">
                        <input id="shareLink" type="text" class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" readonly>
                        <button id="copyLinkButton" class="px-4 py-2.5 bg-indigo-600 text-white rounded-r-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="linkCopiedMessage" class="hidden text-green-600 text-sm mb-2">Link copiado para a área de transferência!</div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Este link permite que qualquer pessoa com acesso veja este relatório específico.</p>
                </div>
            </div>

            <!-- Error Modal -->
            <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-red-600">Erro</h3>
                        <button id="closeErrorModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="mb-4">
                        <svg class="w-12 h-12 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p id="errorMessage" class="text-center text-gray-600 dark:text-gray-300">Erro ao processar o arquivo.</p>
                    </div>
                    <div class="flex justify-center">
                        <button id="confirmErrorButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                            Entendi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication Configuration
        const authConfig = {
            users: [
                { username: "admin", password: "admin123", role: "admin", displayName: "Administrador" },
                { username: "gerente", password: "ger123", role: "admin", displayName: "Gerente" },
                { username: "usuario", password: "user123", role: "user", displayName: "Usuário Comum" }
            ],
            currentUser: null,
            isAuthenticated: false,
            isAdmin: false
        };

        // Main application state
        const appState = {
            imports: [],
            currentImportDate: null,
            currentReportType: 'current', // 'current' or 'all'
            userData: [],
            charts: {},
            pagination: {
                currentPage: 1,
                itemsPerPage: 10,
                totalPages: 1
            },
            sortConfig: {
                key: 'total',
                direction: 'desc'
            }
        };

        // DOM Elements
        const elements = {
            // Auth elements
            authContainer: document.getElementById('authContainer'),
            loginForm: document.getElementById('loginForm'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            loginError: document.getElementById('loginError'),
            closeLoginModal: document.getElementById('closeLoginModal'),
            
            // User info elements
            userInfo: document.getElementById('userInfo'),
            userBadge: document.getElementById('userBadge'),
            userName: document.getElementById('userName'),
            loginButton: document.getElementById('loginButton'),
            logoutButton: document.getElementById('logoutButton'),
            
            // App container
            appContainer: document.getElementById('appContainer'),
            
            // Import section
            fileImportSection: document.getElementById('fileImportSection'),
            csvFileInput: document.getElementById('csvFile'),
            importButton: document.getElementById('importButton'),
            selectedFileName: document.getElementById('selectedFileName'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            emptyState: document.getElementById('emptyState'),
            emptyStateMessage: document.getElementById('emptyStateMessage'),
            
            // Dashboard elements
            dashboardContainer: document.getElementById('dashboardContainer'),
            reportNavigation: document.getElementById('reportNavigation'),
            reportDateSelect: document.getElementById('reportDate'),
            importDateDisplay: document.getElementById('importDate'),
            reportTypeDisplay: document.getElementById('reportType'),
            
            // Share report elements
            shareReportButton: document.getElementById('shareReportButton'),
            shareReportModal: document.getElementById('shareReportModal'),
            closeShareModal: document.getElementById('closeShareModal'),
            shareLinkInput: document.getElementById('shareLink'),
            copyLinkButton: document.getElementById('copyLinkButton'),
            linkCopiedMessage: document.getElementById('linkCopiedMessage'),
            
            // Error modal
            errorModal: document.getElementById('errorModal'),
            closeErrorModal: document.getElementById('closeErrorModal'),
            confirmErrorButton: document.getElementById('confirmErrorButton'),
            errorMessage: document.getElementById('errorMessage'),
            
            // Tabs
            tabs: {
                summary: document.getElementById('summary-tab'),
                details: document.getElementById('details-tab'),
                charts: document.getElementById('charts-tab')
            },
            tabContent: {
                summary: document.getElementById('summary'),
                details: document.getElementById('details'),
                charts: document.getElementById('charts')
            },
            
            // Summary elements
            summaryElements: {
                totalPrintCount: document.getElementById('totalPrintCount'),
                bwPrintCount: document.getElementById('bwPrintCount'),
                colorPrintCount: document.getElementById('colorPrintCount'),
                activeUserCount: document.getElementById('activeUserCount'),
                bwPercentage: document.getElementById('bwPercentage'),
                colorPercentage: document.getElementById('colorPercentage'),
                topUsersTableBody: document.getElementById('topUsersTableBody')
            },
            
            // Details elements
            detailsElements: {
                userDetailsTableBody: document.getElementById('userDetailsTableBody'),
                userSearchInput: document.getElementById('userSearchInput'),
                pagination: document.getElementById('pagination')
            },
            
            // Chart elements
            charts: {
                usageDistribution: document.getElementById('usageDistributionChart'),
                bwVsColor: document.getElementById('bwVsColorChart'),
                topUsers: document.getElementById('topUsersChart'),
                historicalTrend: document.getElementById('historicalTrendChart'),
                usageType: document.getElementById('usageTypeChart'),
                historicalChartContainer: document.getElementById('historicalChartContainer'),
                noHistoricalData: document.getElementById('noHistoricalData')
            }
        };

        // Check for URL parameters on load to support shared links
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs
            initializeTabs();
            
            // Check for shared report URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const sharedDate = urlParams.get('date');
            const reportType = urlParams.get('type');
            
            // Check if this is a shared link access
            if (sharedDate) {
                // Load data from localStorage for the shared date
                loadDataFromLocalStorage();
                
                // If we have imports and the shared date exists
                if (appState.imports.length > 0) {
                    const importExists = appState.imports.some(imp => imp.date === sharedDate);
                    
                    if (importExists) {
                        // This is a shared report, allow access without login
                        appState.currentImportDate = sharedDate;
                        appState.currentReportType = reportType || 'current';
                        elements.reportDateSelect.value = appState.currentReportType;
                        
                        // Set user as guest
                        setGuestUser();
                        
                        // Update UI for the shared report
                        showReportUI();
                        renderReport();
                        return;
                    }
                }
            }
            
            // Set default state as guest
            loadDataFromLocalStorage();
            setGuestUser();
            
            // Check for existing auth session
            checkAuthSession();
            
            // If we have imports, show the latest report
            if (appState.imports.length > 0) {
                appState.currentImportDate = appState.imports[appState.imports.length - 1].date;
                showReportUI();
                renderReport();
            } else {
                // Update empty state message for guests
                elements.emptyStateMessage.textContent = "Não há dados disponíveis para visualização. Aguarde até que um administrador importe um arquivo.";
            }
        });

        // Login form submit handler
        elements.loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = elements.usernameInput.value.trim();
            const password = elements.passwordInput.value;
            
            // Find user
            const user = authConfig.users.find(u => 
                u.username === username && u.password === password
            );
            
            if (user) {
                // Login successful
                elements.loginError.classList.add('hidden');
                loginUser(user);
                elements.authContainer.classList.add('hidden');
            } else {
                // Login failed
                elements.loginError.classList.remove('hidden');
                elements.passwordInput.value = '';
            }
        });

        // Show login modal
        elements.loginButton.addEventListener('click', function() {
            elements.authContainer.classList.remove('hidden');
            elements.usernameInput.value = '';
            elements.passwordInput.value = '';
            elements.loginError.classList.add('hidden');
        });

        // Close login modal
        elements.closeLoginModal.addEventListener('click', function() {
            elements.authContainer.classList.add('hidden');
        });

        // Logout button click handler
        elements.logoutButton.addEventListener('click', function() {
            logoutUser();
        });

        // File input change handler
        elements.csvFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                elements.selectedFileName.textContent = file.name;
                elements.importButton.disabled = false;
            } else {
                elements.selectedFileName.textContent = 'Nenhum arquivo selecionado';
                elements.importButton.disabled = true;
            }
        });

        // Import button click handler
        elements.importButton.addEventListener('click', async function() {
            const file = elements.csvFileInput.files[0];
            if (!file) return;
            
            elements.loadingIndicator.classList.remove('hidden');
            
            try {
                await processCSVFile(file);
                showReportUI();
                renderReport();
            } catch (error) {
                showError(error.message || 'Erro ao processar o arquivo CSV');
            } finally {
                elements.loadingIndicator.classList.add('hidden');
            }
        });

        // Report date change handler
        elements.reportDateSelect.addEventListener('change', function() {
            appState.currentReportType = this.value;
            renderReport();
        });

        // Share report button click handler
        elements.shareReportButton.addEventListener('click', function() {
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?date=${appState.currentImportDate}&type=${appState.currentReportType}`;
            elements.shareLinkInput.value = shareUrl;
            elements.linkCopiedMessage.classList.add('hidden');
            elements.shareReportModal.classList.remove('hidden');
        });

        // Close share modal
        elements.closeShareModal.addEventListener('click', function() {
            elements.shareReportModal.classList.add('hidden');
        });

        // Copy link button
        elements.copyLinkButton.addEventListener('click', function() {
            elements.shareLinkInput.select();
            document.execCommand('copy');
            elements.linkCopiedMessage.classList.remove('hidden');
            
            // Hide the message after 3 seconds
            setTimeout(() => {
                elements.linkCopiedMessage.classList.add('hidden');
            }, 3000);
        });

        // Error modal close handlers
        elements.closeErrorModal.addEventListener('click', function() {
            elements.errorModal.classList.add('hidden');
        });
        
        elements.confirmErrorButton.addEventListener('click', function() {
            elements.errorModal.classList.add('hidden');
        });

        // User search input handler
        elements.detailsElements.userSearchInput.addEventListener('input', function() {
            appState.pagination.currentPage = 1;
            renderUserDetailsTable();
        });

        // Sort table headers
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', function() {
                const sortKey = this.getAttribute('data-sort');
                
                // Toggle direction if same key, otherwise default to desc
                if (appState.sortConfig.key === sortKey) {
                    appState.sortConfig.direction = appState.sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    appState.sortConfig.key = sortKey;
                    appState.sortConfig.direction = 'desc';
                }
                
                // Update sort indicators
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.textContent = '';
                });
                
                const currentIcon = this.querySelector('.sort-icon');
                currentIcon.textContent = appState.sortConfig.direction === 'asc' ? '↑' : '↓';
                
                renderUserDetailsTable();
            });
        });

        // Authentication Functions
        function loginUser(user) {
            authConfig.currentUser = user;
            authConfig.isAuthenticated = true;
            authConfig.isAdmin = user.role === 'admin';
            
            // Save auth to sessionStorage
            sessionStorage.setItem('authUser', JSON.stringify({
                username: user.username,
                role: user.role,
                displayName: user.displayName
            }));
            
            // Update UI
            updateUserInfo(user);
            
            // Show/hide elements based on user role
            elements.userInfo.classList.remove('hidden');
            elements.loginButton.classList.add('hidden');
            
            // Show/hide admin features
            if (authConfig.isAdmin) {
                elements.fileImportSection.classList.remove('hidden');
            } else {
                elements.fileImportSection.classList.add('hidden');
            }
        }

        function logoutUser() {
            // Clear auth state
            authConfig.currentUser = null;
            authConfig.isAuthenticated = false;
            authConfig.isAdmin = false;
            
            // Clear session storage
            sessionStorage.removeItem('authUser');
            
            // Update UI
            elements.userInfo.classList.add('hidden');
            elements.loginButton.classList.remove('hidden');
            elements.fileImportSection.classList.add('hidden');
            
            // Set as guest
            setGuestUser();
        }

        function setGuestUser() {
            authConfig.currentUser = { 
                username: "guest", 
                role: "guest", 
                displayName: "Visitante" 
            };
            authConfig.isAuthenticated = true;
            authConfig.isAdmin = false;
            
            // Hide user info and show login button
            elements.userInfo.classList.add('hidden');
            elements.loginButton.classList.remove('hidden');
            elements.fileImportSection.classList.add('hidden');
        }

        function checkAuthSession() {
            const savedAuth = sessionStorage.getItem('authUser');
            if (savedAuth) {
                try {
                    const parsedAuth = JSON.parse(savedAuth);
                    const user = authConfig.users.find(u => u.username === parsedAuth.username);
                    
                    if (user) {
                        loginUser(user);
                    } else {
                        // Invalid saved user, show as guest
                        setGuestUser();
                    }
                } catch (error) {
                    console.error('Error parsing auth session:', error);
                    setGuestUser();
                }
            }
        }

        function updateUserInfo(user) {
            elements.userName.textContent = user.displayName;
            
            // Update badge style based on role
            if (user.role === 'admin') {
                elements.userBadge.classList.add('admin-badge');
                elements.userBadge.classList.remove('user-badge');
            } else {
                elements.userBadge.classList.add('user-badge');
                elements.userBadge.classList.remove('admin-badge');
            }
        }

        // Initialize tab functionality
        function initializeTabs() {
            Object.keys(elements.tabs).forEach(tabKey => {
                elements.tabs[tabKey].addEventListener('click', function() {
                    // Hide all tab contents
                    Object.values(elements.tabContent).forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Remove active class from all tabs
                    Object.values(elements.tabs).forEach(tab => {
                        tab.classList.remove('tab-active');
                    });
                    
                    // Show selected tab content and mark tab as active
                    const targetId = this.getAttribute('data-tabs-target').substring(1);
                    document.getElementById(targetId).classList.remove('hidden');
                    this.classList.add('tab-active');
                    
                    // Render charts if charts tab is selected
                    if (tabKey === 'charts') {
                        renderCharts();
                    }
                });
            });
        }

        // Process CSV file
        function processCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        try {
                            if (!results.data || results.data.length === 0) {
                                throw new Error('O arquivo não contém dados válidos');
                            }
                            
                            // Process the parsed data
                            const processedData = processData(results.data);
                            
                            // Create a new import record
                            const importDate = new Date().toISOString();
                            
                            // Calculate differences if previous imports exist
                            let periodData = calculatePeriodData(processedData);
                            
                            // Save the import
                            appState.imports.push({
                                date: importDate,
                                rawData: processedData,
                                periodData: periodData,
                                summary: generateSummary(periodData)
                            });
                            
                            // Update the current date
                            appState.currentImportDate = importDate;
                            appState.currentReportType = 'current';
                            
                            // Save to localStorage
                            saveDataToLocalStorage();
                            
                            // Update UI elements
                            elements.reportDateSelect.innerHTML = generateReportDateOptions();
                            elements.reportDateSelect.value = 'current';
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        reject(new Error('Erro ao analisar o arquivo CSV: ' + error.message));
                    }
                });
            });
        }

        // Process the raw CSV data
        function processData(data) {
            return data.map(row => {
                // Extract user info
                const userId = row.Utilizador ? row.Utilizador.replace(/[\[\]"]/g, '') : '';
                const userName = row.Nome ? row.Nome.replace(/[\[\]"]/g, '') : '';
                
                // Extract counts
                const totalPrints = parseInt(row['Total de impressões'] || 0);
                const bwPrints = parseInt(row['P & B(Total de impressões)'] || 0);
                const colorPrints = parseInt(row['Cor (Total de impressões)'] || 0);
                
                // Extract copier counts
                const bwCopier = parseInt(row['Preto e brancoTotal(Copiador/Servidor de Documentos)'] || 0);
                const colorCopier = parseInt(row['Cor únicaTotal(Copiador/Servidor de Documentos)'] || 0) +
                                   parseInt(row['2 CoresTotal(Copiador/Servidor de Documentos)'] || 0) +
                                   parseInt(row['Cor IntegralTotal(Copiador/Servidor de Documentos)'] || 0);
                
                // Extract printer counts
                const bwPrinter = parseInt(row['Preto e brancoTotal(Impressora)'] || 0);
                const colorPrinter = parseInt(row['Cor únicaTotal(Impressora)'] || 0) +
                                    parseInt(row['2 CoresTotal(Impressora)'] || 0) +
                                    parseInt(row['Cor Total(Impressora)'] || 0);
                
                // Calculate totals
                const totalBW = bwPrinter + bwCopier;
                const totalColor = colorPrinter + colorCopier;
                
                // Validate total
                const calculatedTotal = totalBW + totalColor;
                
                return {
                    userId,
                    userName,
                    totalPrints: calculatedTotal, // Use calculated total to ensure consistency
                    bwPrints: totalBW,
                    colorPrints: totalColor,
                    bwCopier,
                    colorCopier,
                    bwPrinter,
                    colorPrinter
                };
            }).filter(user => user.userId && user.userName); // Filter out invalid entries
        }

        // Calculate period data (differences from last import)
        function calculatePeriodData(currentData) {
            // If this is the first import, period data is the same as current data
            if (appState.imports.length === 0) {
                return currentData.map(user => ({
                    ...user,
                    periodTotalPrints: user.totalPrints,
                    periodBWPrints: user.bwPrints,
                    periodColorPrints: user.colorPrints
                }));
            }
            
            // Get the previous import data
            const previousImport = appState.imports[appState.imports.length - 1];
            const previousData = previousImport.rawData;
            
            // Calculate differences
            return currentData.map(currentUser => {
                // Find the user in the previous data
                const previousUser = previousData.find(pu => pu.userId === currentUser.userId);
                
                if (previousUser) {
                    // Calculate differences (ensure no negative values)
                    const periodTotalPrints = Math.max(0, currentUser.totalPrints - previousUser.totalPrints);
                    const periodBWPrints = Math.max(0, currentUser.bwPrints - previousUser.bwPrints);
                    const periodColorPrints = Math.max(0, currentUser.colorPrints - previousUser.colorPrints);
                    
                    return {
                        ...currentUser,
                        periodTotalPrints,
                        periodBWPrints,
                        periodColorPrints
                    };
                } else {
                    // New user, period data is the same as current data
                    return {
                        ...currentUser,
                        periodTotalPrints: currentUser.totalPrints,
                        periodBWPrints: currentUser.bwPrints,
                        periodColorPrints: currentUser.colorPrints
                    };
                }
            });
        }

        // Generate summary statistics
        function generateSummary(userData) {
            // Calculate totals
            const totalPrints = userData.reduce((sum, user) => sum + user.periodTotalPrints, 0);
            const totalBWPrints = userData.reduce((sum, user) => sum + user.periodBWPrints, 0);
            const totalColorPrints = userData.reduce((sum, user) => sum + user.periodColorPrints, 0);
            
            // Calculate active users (users with prints in this period)
            const activeUsers = userData.filter(user => user.periodTotalPrints > 0).length;
            
            // Calculate percentages
            const bwPercentage = totalPrints > 0 ? (totalBWPrints / totalPrints) * 100 : 0;
            const colorPercentage = totalPrints > 0 ? (totalColorPrints / totalPrints) * 100 : 0;
            
            // Get top users
            const topUsers = [...userData]
                .sort((a, b) => b.periodTotalPrints - a.periodTotalPrints)
                .slice(0, 5)
                .map(user => ({
                    userId: user.userId,
                    userName: user.userName,
                    totalPrints: user.periodTotalPrints,
                    bwPrints: user.periodBWPrints,
                    colorPrints: user.periodColorPrints,
                    percentage: totalPrints > 0 ? (user.periodTotalPrints / totalPrints) * 100 : 0
                }));
            
            return {
                totalPrints,
                totalBWPrints,
                totalColorPrints,
                activeUsers,
                bwPercentage,
                colorPercentage,
                topUsers
            };
        }

        // Show the report UI (hide empty state)
        function showReportUI() {
            elements.emptyState.classList.add('hidden');
            elements.dashboardContainer.classList.remove('hidden');
            elements.reportNavigation.classList.remove('hidden');
        }

        // Render the current report
        function renderReport() {
            if (appState.imports.length === 0) return;
            
            // Get the current import data
            const currentImport = appState.imports.find(imp => imp.date === appState.currentImportDate);
            if (!currentImport) return;
            
            // Set data based on report type
            let userData, summary;
            
            if (appState.currentReportType === 'current') {
                // Period data (differences since last import)
                userData = currentImport.periodData;
                summary = currentImport.summary;
                elements.reportTypeDisplay.textContent = 'Período (desde último import)';
            } else {
                // Global data (cumulative totals)
                userData = currentImport.rawData;
                summary = generateSummary(userData.map(user => ({
                    ...user,
                    periodTotalPrints: user.totalPrints,
                    periodBWPrints: user.bwPrints,
                    periodColorPrints: user.colorPrints
                })));
                elements.reportTypeDisplay.textContent = 'Global (contador acumulado)';
            }
            
            // Store in app state for use in other functions
            appState.userData = userData;
            
            // Format the date for display
            const importDate = new Date(currentImport.date);
            elements.importDateDisplay.textContent = importDate.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Update summary elements
            elements.summaryElements.totalPrintCount.textContent = formatNumber(summary.totalPrints);
            elements.summaryElements.bwPrintCount.textContent = formatNumber(summary.totalBWPrints);
            elements.summaryElements.colorPrintCount.textContent = formatNumber(summary.totalColorPrints);
            elements.summaryElements.activeUserCount.textContent = formatNumber(summary.activeUsers);
            elements.summaryElements.bwPercentage.textContent = formatPercentage(summary.bwPercentage);
            elements.summaryElements.colorPercentage.textContent = formatPercentage(summary.colorPercentage);
            
            // Render top users table
            renderTopUsersTable(summary.topUsers);
            
            // Render user details table
            renderUserDetailsTable();
            
            // Generate charts
            renderCharts();
        }

        // Render the top users table
        function renderTopUsersTable(topUsers) {
            const tableBody = elements.summaryElements.topUsersTableBody;
            tableBody.innerHTML = '';
            
            if (topUsers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                        Nenhum dado disponível
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            topUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                        ${user.userName}
                    </td>
                    <td class="px-6 py-4">${formatNumber(user.totalPrints)}</td>
                    <td class="px-6 py-4">${formatNumber(user.bwPrints)}</td>
                    <td class="px-6 py-4">${formatNumber(user.colorPrints)}</td>
                    <td class="px-6 py-4">${formatPercentage(user.percentage)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render the user details table with sorting and filtering
        function renderUserDetailsTable() {
            const tableBody = elements.detailsElements.userDetailsTableBody;
            tableBody.innerHTML = '';
            
            // Get filtered and sorted user data
            let filteredUsers = [...appState.userData];
            
            // Apply search filter
            const searchTerm = elements.detailsElements.userSearchInput.value.toLowerCase();
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user => 
                    user.userName.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort the data
            filteredUsers.sort((a, b) => {
                let valueA, valueB;
                
                switch (appState.sortConfig.key) {
                    case 'name':
                        valueA = a.userName.toLowerCase();
                        valueB = b.userName.toLowerCase();
                        break;
                    case 'total':
                        valueA = appState.currentReportType === 'current' ? a.periodTotalPrints : a.totalPrints;
                        valueB = appState.currentReportType === 'current' ? b.periodTotalPrints : b.totalPrints;
                        break;
                    case 'bw':
                        valueA = appState.currentReportType === 'current' ? a.periodBWPrints : a.bwPrints;
                        valueB = appState.currentReportType === 'current' ? b.periodBWPrints : b.bwPrints;
                        break;
                    case 'color':
                        valueA = appState.currentReportType === 'current' ? a.periodColorPrints : a.colorPrints;
                        valueB = appState.currentReportType === 'current' ? b.periodColorPrints : b.colorPrints;
                        break;
                    case 'percentage':
                        const totalPrints = appState.userData.reduce((sum, user) => {
                            return sum + (appState.currentReportType === 'current' ? user.periodTotalPrints : user.totalPrints);
                        }, 0);
                        valueA = totalPrints > 0 ? ((appState.currentReportType === 'current' ? a.periodTotalPrints : a.totalPrints) / totalPrints) * 100 : 0;
                        valueB = totalPrints > 0 ? ((appState.currentReportType === 'current' ? b.periodTotalPrints : b.totalPrints) / totalPrints) * 100 : 0;
                        break;
                    default:
                        valueA = appState.currentReportType === 'current' ? a.periodTotalPrints : a.totalPrints;
                        valueB = appState.currentReportType === 'current' ? b.periodTotalPrints : b.totalPrints;
                }
                
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    return appState.sortConfig.direction === 'asc'
                        ? valueA.localeCompare(valueB)
                        : valueB.localeCompare(valueA);
                } else {
                    return appState.sortConfig.direction === 'asc'
                        ? valueA - valueB
                        : valueB - valueA;
                }
            });
            
            // Update pagination
            appState.pagination.totalPages = Math.ceil(filteredUsers.length / appState.pagination.itemsPerPage);
            if (appState.pagination.currentPage > appState.pagination.totalPages) {
                appState.pagination.currentPage = Math.max(1, appState.pagination.totalPages);
            }
            
            // Get the current page data
            const startIndex = (appState.pagination.currentPage - 1) * appState.pagination.itemsPerPage;
            const paginatedUsers = filteredUsers.slice(startIndex, startIndex + appState.pagination.itemsPerPage);
            
            if (paginatedUsers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                        Nenhum usuário encontrado
                    </td>
                `;
                tableBody.appendChild(row);
            } else {
                // Calculate total for percentage
                const totalPrints = appState.userData.reduce((sum, user) => {
                    return sum + (appState.currentReportType === 'current' ? user.periodTotalPrints : user.totalPrints);
                }, 0);
                
                // Render the table rows
                paginatedUsers.forEach(user => {
                    const totalValue = appState.currentReportType === 'current' ? user.periodTotalPrints : user.totalPrints;
                    const bwValue = appState.currentReportType === 'current' ? user.periodBWPrints : user.bwPrints;
                    const colorValue = appState.currentReportType === 'current' ? user.periodColorPrints : user.colorPrints;
                    const percentage = totalPrints > 0 ? (totalValue / totalPrints) * 100 : 0;
                    
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                            ${user.userName}
                        </td>
                        <td class="px-6 py-4">${formatNumber(totalValue)}</td>
                        <td class="px-6 py-4">${formatNumber(bwValue)}</td>
                        <td class="px-6 py-4">${formatNumber(colorValue)}</td>
                        <td class="px-6 py-4">${formatPercentage(percentage)}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // Render pagination controls
            renderPagination();
        }

        // Render pagination controls
        function renderPagination() {
            const paginationElement = elements.detailsElements.pagination;
            paginationElement.innerHTML = '';
            
            if (appState.pagination.totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevButton = document.createElement('li');
            prevButton.innerHTML = `
                <button class="block px-3 py-2 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white ${appState.pagination.currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                    <span class="sr-only">Anterior</span>
                    <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            
            if (appState.pagination.currentPage !== 1) {
                prevButton.querySelector('button').addEventListener('click', () => {
                    appState.pagination.currentPage--;
                    renderUserDetailsTable();
                });
            }
            
            paginationElement.appendChild(prevButton);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, appState.pagination.currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(appState.pagination.totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if needed
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page if not visible
            if (startPage > 1) {
                const firstPageButton = document.createElement('li');
                firstPageButton.innerHTML = `
                    <button class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">1</button>
                `;
                firstPageButton.querySelector('button').addEventListener('click', () => {
                    appState.pagination.currentPage = 1;
                    renderUserDetailsTable();
                });
                paginationElement.appendChild(firstPageButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('li');
                    ellipsis.innerHTML = `
                        <span class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400">...</span>
                    `;
                    paginationElement.appendChild(ellipsis);
                }
            }
            
            // Page buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('li');
                const isActive = i === appState.pagination.currentPage;
                
                pageButton.innerHTML = `
                    <button class="px-3 py-2 leading-tight ${isActive 
                        ? 'text-indigo-600 bg-indigo-50 border border-indigo-300 hover:bg-indigo-100 dark:bg-indigo-900 dark:border-indigo-700 dark:text-indigo-400'
                        : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'
                    }">${i}</button>
                `;
                
                if (!isActive) {
                    pageButton.querySelector('button').addEventListener('click', () => {
                        appState.pagination.currentPage = i;
                        renderUserDetailsTable();
                    });
                }
                
                paginationElement.appendChild(pageButton);
            }
            
            // Last page if not visible
            if (endPage < appState.pagination.totalPages) {
                if (endPage < appState.pagination.totalPages - 1) {
                    const ellipsis = document.createElement('li');
                    ellipsis.innerHTML = `
                        <span class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400">...</span>
                    `;
                    paginationElement.appendChild(ellipsis);
                }
                
                const lastPageButton = document.createElement('li');
                lastPageButton.innerHTML = `
                    <button class="px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">${appState.pagination.totalPages}</button>
                `;
                lastPageButton.querySelector('button').addEventListener('click', () => {
                    appState.pagination.currentPage = appState.pagination.totalPages;
                    renderUserDetailsTable();
                });
                paginationElement.appendChild(lastPageButton);
            }
            
            // Next button
            const nextButton = document.createElement('li');
            nextButton.innerHTML = `
                <button class="block px-3 py-2 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white ${appState.pagination.currentPage === appState.pagination.totalPages ? 'opacity-50 cursor-not-allowed' : ''}">
                    <span class="sr-only">Próxima</span>
                    <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            
            if (appState.pagination.currentPage !== appState.pagination.totalPages) {
                nextButton.querySelector('button').addEventListener('click', () => {
                    appState.pagination.currentPage++;
                    renderUserDetailsTable();
                });
            }
            
            paginationElement.appendChild(nextButton);
        }

        // Render all charts
        function renderCharts() {
            // Destroy existing charts to avoid duplicates
            Object.keys(appState.charts).forEach(key => {
                if (appState.charts[key]) {
                    appState.charts[key].destroy();
                    appState.charts[key] = null;
                }
            });
            
            // Collect data for charts
            const userData = appState.userData;
            
            // Calculate total values
            let totalPrints = 0;
            let totalBWPrints = 0;
            let totalColorPrints = 0;
            
            // Use the correct count properties based on report type
            if (appState.currentReportType === 'current') {
                totalPrints = userData.reduce((sum, user) => sum + user.periodTotalPrints, 0);
                totalBWPrints = userData.reduce((sum, user) => sum + user.periodBWPrints, 0);
                totalColorPrints = userData.reduce((sum, user) => sum + user.periodColorPrints, 0);
            } else {
                totalPrints = userData.reduce((sum, user) => sum + user.totalPrints, 0);
                totalBWPrints = userData.reduce((sum, user) => sum + user.bwPrints, 0);
                totalColorPrints = userData.reduce((sum, user) => sum + user.colorPrints, 0);
            }
            
            // Get top users for the chart
            const topUsers = [...userData]
                .sort((a, b) => {
                    const aValue = appState.currentReportType === 'current' ? a.periodTotalPrints : a.totalPrints;
                    const bValue = appState.currentReportType === 'current' ? b.periodTotalPrints : b.totalPrints;
                    return bValue - aValue;
                })
                .slice(0, 10)
                .filter(user => (appState.currentReportType === 'current' ? user.periodTotalPrints : user.totalPrints) > 0);
            
            // Render usage distribution chart
            renderUsageDistributionChart(totalBWPrints, totalColorPrints);
            
            // Render BW vs Color chart
            renderBWVsColorChart(totalBWPrints, totalColorPrints);
            
            // Render top users chart
            renderTopUsersChart(topUsers);
            
            // Render historical trend chart if multiple imports exist
            renderHistoricalTrendChart();
            
            // Render usage type chart
            renderUsageTypeChart(userData);
        }

        // Render the usage distribution chart
        function renderUsageDistributionChart(totalBWPrints, totalColorPrints) {
            const ctx = elements.charts.usageDistribution.getContext('2d');
            
            // Define colors with transparency for light and dark mode
            const usageColors = ['rgb(31, 41, 55)', 'rgb(79, 70, 229)'];
            
            appState.charts.usageDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['P&B', 'Colorido'],
                    datasets: [{
                        data: [totalBWPrints, totalColorPrints],
                        backgroundColor: usageColors,
                        borderColor: 'transparent',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${context.label}: ${formatNumber(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        // Render the BW vs Color chart
        function renderBWVsColorChart(totalBWPrints, totalColorPrints) {
            const ctx = elements.charts.bwVsColor.getContext('2d');
            
            appState.charts.bwVsColor = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Preto e Branco', 'Colorido'],
                    datasets: [{
                        label: 'Número de Impressões',
                        data: [totalBWPrints, totalColorPrints],
                        backgroundColor: [
                            'rgba(31, 41, 55, 0.7)',
                            'rgba(79, 70, 229, 0.7)'
                        ],
                        borderColor: [
                            'rgb(31, 41, 55)',
                            'rgb(79, 70, 229)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatNumber(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render the top users chart
        function renderTopUsersChart(topUsers) {
            const ctx = elements.charts.topUsers.getContext('2d');
            
            const labels = topUsers.map(user => user.userName);
            const data = topUsers.map(user => appState.currentReportType === 'current' ? user.periodTotalPrints : user.totalPrints);
            const bwData = topUsers.map(user => appState.currentReportType === 'current' ? user.periodBWPrints : user.bwPrints);
            const colorData = topUsers.map(user => appState.currentReportType === 'current' ? user.periodColorPrints : user.colorPrints);
            
            appState.charts.topUsers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'P&B',
                        data: bwData,
                        backgroundColor: 'rgba(31, 41, 55, 0.7)',
                        borderColor: 'rgb(31, 41, 55)',
                        borderWidth: 1
                    }, {
                        label: 'Colorido',
                        data: colorData,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatNumber(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render the historical trend chart
        function renderHistoricalTrendChart() {
            // Only show historical chart if we have multiple imports
            if (appState.imports.length <= 1) {
                elements.charts.historicalChartContainer.classList.add('hidden');
                elements.charts.noHistoricalData.classList.remove('hidden');
                return;
            }
            
            elements.charts.historicalChartContainer.classList.remove('hidden');
            elements.charts.noHistoricalData.classList.add('hidden');
            
            const ctx = elements.charts.historicalTrend.getContext('2d');
            
            // Collect data for each import
            const labels = [];
            const totalData = [];
            const bwData = [];
            const colorData = [];
            
            appState.imports.forEach(imp => {
                const date = new Date(imp.date);
                const dateLabel = date.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit'
                });
                
                labels.push(dateLabel);
                totalData.push(imp.summary.totalPrints);
                bwData.push(imp.summary.totalBWPrints);
                colorData.push(imp.summary.totalColorPrints);
            });
            
            appState.charts.historicalTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total',
                        data: totalData,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: 'rgb(79, 70, 229)',
                        pointRadius: 4
                    }, {
                        label: 'P&B',
                        data: bwData,
                        borderColor: 'rgb(31, 41, 55)',
                        backgroundColor: 'rgba(31, 41, 55, 0.05)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: 'rgb(31, 41, 55)',
                        pointRadius: 4
                    }, {
                        label: 'Colorido',
                        data: colorData,
                        borderColor: 'rgb(124, 58, 237)',
                        backgroundColor: 'rgba(124, 58, 237, 0.05)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: 'rgb(124, 58, 237)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatNumber(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render the usage type chart
        function renderUsageTypeChart(userData) {
            const ctx = elements.charts.usageType.getContext('2d');
            
            // Calculate totals by type
            let printerBW = 0;
            let printerColor = 0;
            let copierBW = 0;
            let copierColor = 0;
            
            userData.forEach(user => {
                if (appState.currentReportType === 'current') {
                    // For current report, we need to calculate the period values for each type
                    // This is an approximation since we don't store the exact breakdown in period data
                    const totalBW = user.bwPrints;
                    const periodBW = user.periodBWPrints;
                    
                    if (totalBW > 0) {
                        const bwRatio = periodBW / totalBW;
                        printerBW += user.bwPrinter * bwRatio;
                        copierBW += user.bwCopier * bwRatio;
                    }
                    
                    const totalColor = user.colorPrints;
                    const periodColor = user.periodColorPrints;
                    
                    if (totalColor > 0) {
                        const colorRatio = periodColor / totalColor;
                        printerColor += user.colorPrinter * colorRatio;
                        copierColor += user.colorCopier * colorRatio;
                    }
                } else {
                    // For global report, we can use the raw values
                    printerBW += user.bwPrinter;
                    printerColor += user.colorPrinter;
                    copierBW += user.bwCopier;
                    copierColor += user.colorCopier;
                }
            });
            
            appState.charts.usageType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Impressora P&B', 'Impressora Colorida', 'Copiadora P&B', 'Copiadora Colorida'],
                    datasets: [{
                        data: [printerBW, printerColor, copierBW, copierColor],
                        backgroundColor: [
                            'rgba(31, 41, 55, 0.8)',
                            'rgba(79, 70, 229, 0.8)',
                            'rgba(31, 41, 55, 0.4)',
                            'rgba(79, 70, 229, 0.4)'
                        ],
                        borderColor: 'transparent',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${context.label}: ${formatNumber(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate the date options for the report selector
        function generateReportDateOptions() {
            let options = `
                <option value="current">Período Atual</option>
                <option value="all">Contador Global</option>
            `;
            
            return options;
        }

        // Save data to localStorage
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('printerCounterData', JSON.stringify(appState.imports));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showError('Não foi possível salvar os dados localmente. O armazenamento local pode estar desativado ou cheio.');
            }
        }

        // Load data from localStorage
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('printerCounterData');
                if (savedData) {
                    appState.imports = JSON.parse(savedData);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                appState.imports = [];
            }
        }

        // Format a number with thousands separator
        function formatNumber(num) {
            return new Intl.NumberFormat('pt-BR').format(Math.round(num));
        }

        // Format a percentage value
        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', { 
                style: 'percent',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value / 100);
        }

        // Show error modal
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorModal.classList.remove('hidden');
        }
    </script>
</body>
</html>